<!DOCTYPE html><html lang="en"><head><title>app/back/client/quizzes</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="app/back/client/quizzes"><meta name="groc-project-path" content="app/back/client/quizzes.coffee"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">app/back/client/quizzes.coffee</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="back-client-side-quiz-mgmt">Back client-side quiz mgmt</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The toolkit box is shared by the backoffice UI and frontoffice UI.</p></div></div><div class="code"><div class="wrapper"><span class="nv">toolkit = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;client/toolkit&#39;</span><span class="p">)</span>

<span class="nv">socket = </span><span class="nx">io</span><span class="p">.</span><span class="nx">connect</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Hook quiz starter buttons to ajaxify it and stay on page.</p></div></div><div class="code"><div class="wrapper"><span class="nv">ajaxifyStarts = </span><span class="nf">-&gt;</span>
  <span class="nx">$</span><span class="p">(</span><span class="s">&#39;form[data-action=&quot;start&quot;]&#39;</span><span class="p">).</span><span class="nx">on</span> <span class="s">&#39;submit&#39;</span><span class="p">,</span> <span class="nf">(e) -&gt;</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
    <span class="nv">form = </span><span class="nx">$</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
    <span class="nx">form</span><span class="p">.</span><span class="nx">prev</span><span class="p">(</span><span class="s">&#39;.start-notice&#39;</span><span class="p">).</span><span class="nx">show</span><span class="p">()</span>
    <span class="p">(</span><span class="nx">$</span> <span class="s">&#39;.alert&#39;</span><span class="p">).</span><span class="nx">hide</span><span class="p">()</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span> <span class="nx">form</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;action&#39;</span><span class="p">),</span>
      <span class="nv">type: </span><span class="nx">form</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;method&#39;</span><span class="p">)</span>
      <span class="nv">data: </span><span class="nx">form</span><span class="p">.</span><span class="nx">serialize</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Hook the "next question" button (through event delegation, as
it may get in the page later on) to ajaxify it and stay on page.</p></div></div><div class="code"><div class="wrapper"><span class="nv">ajaxifyNext = </span><span class="nf">-&gt;</span>
  <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">on</span> <span class="s">&#39;click&#39;</span><span class="p">,</span> <span class="s">&#39;a#nextQuestion&#39;</span><span class="p">,</span> <span class="nf">(e) -&gt;</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">.</span><span class="nx">href</span><span class="p">,</span> <span class="nv">type: </span><span class="s">&#39;post&#39;</span><span class="p">,</span> <span class="nv">data: </span><span class="p">{</span> <span class="nv">_method: </span><span class="s">&#39;put&#39;</span> <span class="p">})</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>React to quiz joins by updating the displayed player counts on
the current quiz (post-init).</p></div></div><div class="code"><div class="wrapper"><span class="nv">maintainBackPlayerCount = </span><span class="nf">-&gt;</span>
  <span class="nv">counter = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#currentPlayers&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="k">unless</span> <span class="nx">counter</span><span class="p">.</span><span class="nx">length</span>

  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;quiz-join&#39;</span><span class="p">,</span> <span class="nf">(user, playerCountStr) -&gt;</span>
    <span class="nx">counter</span><span class="p">.</span><span class="nx">text</span> <span class="nx">playerCountStr</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Hook into workflow notifications to update the back UI
in the quiz listing.</p></div></div><div class="code"><div class="wrapper"><span class="nv">maintainQuestionFeedback = </span><span class="nf">-&gt;</span>
  <span class="nv">series = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#currentAnswers&#39;</span><span class="p">)</span>
  <span class="nv">countDown = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#countDown&#39;</span><span class="p">)</span>
  <span class="nv">feedback = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#feedback&#39;</span><span class="p">)</span>
  <span class="nv">feedbackTpl = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;back/client/question_stats&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Question starts clean up the dynamic UI and start
the countdown.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;question-start&#39;</span><span class="p">,</span> <span class="nf">(question, expiresAt) -&gt;</span>
    <span class="nx">series</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">).</span><span class="nx">show</span><span class="p">()</span>
    <span class="nx">feedback</span><span class="p">.</span><span class="nx">html</span> <span class="s">&#39;&#39;</span>
    <span class="nv">question.expiresAt = </span><span class="nx">expiresAt</span>
    <span class="nv">question.remainingTime = </span><span class="nx">toolkit</span><span class="p">.</span><span class="nx">remainingTime</span>
    <span class="nx">countDown</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">question</span><span class="p">.</span><span class="nx">remainingTime</span><span class="p">()).</span><span class="nx">show</span><span class="p">()</span>

    <span class="nv">chrono = </span><span class="nf">-&gt;</span>
      <span class="nx">clearInterval</span> <span class="nx">itv</span> <span class="k">if</span> <span class="nx">question</span><span class="p">.</span><span class="nx">expiresAt</span> <span class="o">&lt;=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span>
      <span class="nx">countDown</span><span class="p">.</span><span class="nx">text</span> <span class="nx">question</span><span class="p">.</span><span class="nx">remainingTime</span><span class="p">()</span>

    <span class="nv">itv = </span><span class="nx">setInterval</span><span class="p">(</span><span class="nx">chrono</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>React to question-end stats by displaying them using a shared
stats view (which also contains a "next question" button).</p></div></div><div class="code"><div class="wrapper">  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;question-end&#39;</span><span class="p">,</span> <span class="nf">(stats, quizId) -&gt;</span>
    <span class="nx">countDown</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>
    <span class="nx">series</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>
    <span class="nx">feedback</span><span class="p">.</span><span class="nx">html</span> <span class="nx">feedbackTpl</span><span class="p">({</span> <span class="nv">stats: </span><span class="nx">stats</span><span class="p">,</span> <span class="nv">quizId: </span><span class="nx">quizId</span> <span class="p">})</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Display dots when answers get sent to the engine.  First-answer
is a blue dot, re-answer turns the dot orange.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;new-answer&#39;</span><span class="p">,</span> <span class="nf">(userId) -&gt;</span>
    <span class="nx">series</span><span class="p">.</span><span class="nx">append</span> <span class="s">&quot;&lt;li data-user-id=&#39;</span><span class="si">#{</span><span class="nx">userId</span><span class="si">}</span><span class="s">&#39;&gt;•&lt;/li&gt;&quot;</span>

  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;edit-answer&#39;</span><span class="p">,</span> <span class="nf">(userId) -&gt;</span>
    <span class="nx">series</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&quot;li[data-user-id=</span><span class="si">#{</span><span class="nx">userId</span><span class="si">}</span><span class="s">]&quot;</span><span class="p">).</span><span class="nx">addClass</span> <span class="s">&#39;changed&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Quiz ends?  Redirect to scoreboard!</p></div></div><div class="code"><div class="wrapper">  <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span> <span class="s">&#39;quiz-end&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">location.href = </span><span class="s">&#39;/admin/quizzes/scoreboard&#39;</span>

<span class="nx">$</span> <span class="nf">-&gt;</span>
  <span class="nx">ajaxifyStarts</span><span class="p">()</span>
  <span class="nx">ajaxifyNext</span><span class="p">()</span>
  <span class="nx">maintainBackPlayerCount</span><span class="p">()</span>
  <span class="nx">maintainQuestionFeedback</span><span class="p">()</span></div></div></div></div></body></html>