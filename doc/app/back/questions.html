<!DOCTYPE html><html lang="en"><head><title>app/back/questions</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="app/back/questions"><meta name="groc-project-path" content="app/back/questions.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">app/back/questions.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="backoffice-sub-app-question-mgmt">Backoffice sub-app: question mgmt</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">Question</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/question&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Answer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../models/answer&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">);</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">questionsApp</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="subapp-setup">Subapp setup</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is the function this module exports.  Because Express will block
any further middleware once a route is registered, this behaves in two
modes: middleware (non-route) and route (non-middleware).  Calling it
without a mode (or with an invalid mode) does everything.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">questionsApp</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">mode</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Middleware-only or generic context</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;routes&#39;</span> <span class="o">!==</span> <span class="nx">mode</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Subapp model checking, so we have <code>req.question</code> whenever relevant.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/admin/quizzes&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">checkQuestionModel</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">questionId</span> <span class="o">=</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\/questions\/(\d+)\b/</span><span class="p">)</span> <span class="o">||</span> <span class="p">[])[</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="kc">undefined</span> <span class="o">===</span> <span class="nx">questionId</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>

      <span class="nx">req</span><span class="p">.</span><span class="nx">quiz</span><span class="p">.</span><span class="nx">getQuestions</span><span class="p">({</span> <span class="nx">where</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;questions.id&#39;</span><span class="o">:</span> <span class="nx">questionId</span> <span class="p">},</span> <span class="nx">include</span><span class="o">:</span> <span class="p">[</span><span class="nx">Answer</span><span class="p">],</span> <span class="nx">order</span><span class="o">:</span> <span class="s1">&#39;answers.position&#39;</span> <span class="p">}).</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">qs</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">qs</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">req</span><span class="p">.</span><span class="nx">question</span> <span class="o">=</span> <span class="nx">qs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
          <span class="nx">next</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Cette question est introuvable.&#39;</span><span class="p">);</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/admin/quizzes/&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">quiz</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;/edit&#39;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Route-only or generic context</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;middleware&#39;</span> <span class="o">!==</span> <span class="nx">mode</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Namespaced routes (REST resource routes, basically)</p></div></div><div class="code"><div class="wrapper">    <span class="nx">app</span><span class="p">.</span><span class="nx">namespace</span><span class="p">(</span><span class="s1">&#39;/:quiz_id/questions&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;/new&#39;</span><span class="p">,</span>      <span class="nx">newQuestion</span><span class="p">);</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span>         <span class="nx">createQuestion</span><span class="p">);</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s1">&#39;/:id/edit&#39;</span><span class="p">,</span> <span class="nx">editQuestion</span><span class="p">);</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span> <span class="s1">&#39;/:id&#39;</span><span class="p">,</span>      <span class="nx">updateQuestion</span><span class="p">);</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span> <span class="s1">&#39;/:id&#39;</span><span class="p">,</span>      <span class="nx">deleteQuestion</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="quiz-resource-actions">Quiz resource actions</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Action: create question</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">createQuestion</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">question</span> <span class="o">=</span> <span class="nx">Question</span><span class="p">.</span><span class="nx">build</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">question</span><span class="p">);</span>
  <span class="nx">question</span><span class="p">.</span><span class="nx">quizId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">quiz</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We sequence methods (async or not) here using promises.  The error case is
handled by passing the last <code>.then</code> call a second callback.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">req</span><span class="p">.</span><span class="nx">quiz</span><span class="p">.</span><span class="nx">getNextQuestionPosition</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">nextPos</span><span class="p">)</span> <span class="p">{</span> <span class="nx">question</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="nx">nextPos</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span> <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">question</span><span class="p">.</span><span class="nx">save</span><span class="p">();</span> <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">saveAnswers</span><span class="p">(</span><span class="nx">question</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">answers</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="s1">&#39;La question « &#39;</span> <span class="o">+</span> <span class="nx">question</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="s1">&#39; » a bien été créée.&#39;</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s2">&quot;/admin/quizzes/&quot;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">quiz</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot;/edit?tab=questions&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;Ooops&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">question</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;questions/new&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">answers</span><span class="o">:</span> <span class="nx">buildAnswers</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">answers</span><span class="p">),</span>
        <span class="nx">quiz</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">quiz</span><span class="p">,</span>
        <span class="nx">question</span><span class="o">:</span> <span class="nx">question</span><span class="p">,</span>
        <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Nouvelle question&#39;</span><span class="p">,</span>
        <span class="nx">breadcrumbs</span><span class="o">:</span> <span class="nx">buildBreadcrumbs</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">quiz</span><span class="p">)</span>
      <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Action: delete question</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">deleteQuestion</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">destroy</span><span class="p">().</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="s2">&quot;La question « &quot;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="s2">&quot; » a bien été supprimée.&quot;</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/admin/quizzes/&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">quiz</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;/edit&#39;</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Action: edit question</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">editQuestion</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;questions/edit&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">quiz</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">quiz</span><span class="p">,</span>
    <span class="nx">question</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">question</span><span class="p">,</span>
    <span class="nx">answers</span><span class="o">:</span> <span class="nx">buildAnswers</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">answers</span><span class="p">),</span>
    <span class="nx">title</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">question</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
    <span class="nx">breadcrumbs</span><span class="o">:</span> <span class="nx">buildBreadcrumbs</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">quiz</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">question</span><span class="p">)</span>
  <span class="p">});</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Action: new question</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">newQuestion</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">question</span> <span class="o">=</span> <span class="nx">Question</span><span class="p">.</span><span class="nx">build</span><span class="p">();</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;questions/new&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="nx">answers</span><span class="o">:</span> <span class="nx">buildAnswers</span><span class="p">([]),</span>
    <span class="nx">quiz</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">quiz</span><span class="p">,</span>
    <span class="nx">question</span><span class="o">:</span> <span class="nx">question</span><span class="p">,</span>
    <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;Nouvelle question&#39;</span><span class="p">,</span>
    <span class="nx">breadcrumbs</span><span class="o">:</span> <span class="nx">buildBreadcrumbs</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">quiz</span><span class="p">)</span>
  <span class="p">});</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Action: update question</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">updateQuestion</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">question</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">question</span><span class="p">;</span>
  <span class="nx">question</span><span class="p">.</span><span class="nx">updateAttributes</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">question</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">saveAnswers</span><span class="p">(</span><span class="nx">question</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">answers</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">req</span><span class="p">.</span><span class="nx">flash</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="s1">&#39;La question « &#39;</span> <span class="o">+</span> <span class="nx">question</span><span class="p">.</span><span class="nx">title</span> <span class="o">+</span> <span class="s1">&#39; » a bien été mise à jour.&#39;</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s2">&quot;/admin/quizzes/&quot;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">quiz</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot;/edit?tab=questions&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s1">&#39;Ooops&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">question</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;QUESTION ERRORS:&#39;</span><span class="p">,</span> <span class="nx">question</span><span class="p">.</span><span class="nx">errors</span><span class="p">);</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;questions/edit&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">answers</span><span class="o">:</span> <span class="nx">buildAnswers</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">answers</span><span class="p">),</span>
        <span class="nx">quiz</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">quiz</span><span class="p">,</span>
        <span class="nx">question</span><span class="o">:</span> <span class="nx">question</span><span class="p">,</span>
        <span class="nx">title</span><span class="o">:</span> <span class="nx">question</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
        <span class="nx">breadcrumbs</span><span class="o">:</span> <span class="nx">buildBreadcrumbs</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">quiz</span><span class="p">,</span> <span class="nx">question</span><span class="p">)</span>
      <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="inlined-answers-management">Inlined answers management</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">MIN_PROPOSED_ANSWERS</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">MIN_BLANKED_ANSWERS</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">RE_BLANK</span> <span class="o">=</span> <span class="sr">/^\s*$/</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Convenience method to ensure our answers array includes a minimum amount of
<code>Answer</code> objects <strong>and</strong> at least a given amount of blank answers for further addition.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">buildAnswers</span><span class="p">(</span><span class="nx">existing</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">blankAnswers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">existing</span><span class="p">.</span><span class="nx">slice</span><span class="p">();</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">MIN_PROPOSED_ANSWERS</span> <span class="o">||</span> <span class="nx">blankAnswers</span> <span class="o">&lt;</span> <span class="nx">MIN_BLANKED_ANSWERS</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">Answer</span><span class="p">.</span><span class="nx">build</span><span class="p">());</span>
    <span class="o">++</span><span class="nx">blankAnswers</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Core code for inlined answers saving.  This ignores blank answers
and (sheer laziness) assumes all errors we could get on saves are validation
errors (which happen to be synchronous), not async DB errors.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">saveAnswers</span><span class="p">(</span><span class="nx">question</span><span class="p">,</span> <span class="nx">paramAnswers</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">pos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">hasErrors</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="nx">paramAnswers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">pa</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="nx">updateAnswer</span><span class="p">(</span><span class="nx">answer</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If called by getAnswers</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">answer</span><span class="p">))</span>
        <span class="nx">answer</span> <span class="o">=</span> <span class="nx">answer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Dev note: the body params struct passed in apparently has no .hasOwnProperty?!?
Cloning it to a plain object works around this.</p></div></div><div class="code"><div class="wrapper">      <span class="nx">answer</span><span class="p">.</span><span class="nx">setAttributes</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">pa</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Empty answers should be ignored/removed</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="p">(</span><span class="nx">RE_BLANK</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">answer</span><span class="p">.</span><span class="nx">text</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">answer</span><span class="p">.</span><span class="nx">isNewRecord</span><span class="p">)</span>
          <span class="nx">answer</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Fields are serialized in document order by the browser, so...</p></div></div><div class="code"><div class="wrapper">      <span class="nx">answer</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="nx">pos</span><span class="o">++</span><span class="p">;</span>
      <span class="nx">answer</span><span class="p">.</span><span class="nx">questionId</span> <span class="o">=</span> <span class="nx">question</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
      <span class="nx">answer</span><span class="p">.</span><span class="nx">save</span><span class="p">().</span><span class="nx">error</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">answer</span><span class="p">.</span><span class="nx">errors</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">_</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
        <span class="nx">hasErrors</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">pa</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
      <span class="nx">question</span><span class="p">.</span><span class="nx">getAnswers</span><span class="p">({</span> <span class="nx">where</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">pa</span><span class="p">.</span><span class="nx">id</span> <span class="p">}</span> <span class="p">}).</span><span class="nx">success</span><span class="p">(</span><span class="nx">updateAnswer</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="nx">updateAnswer</span><span class="p">(</span><span class="nx">Answer</span><span class="p">.</span><span class="nx">build</span><span class="p">());</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="o">!</span><span class="nx">hasErrors</span><span class="p">;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Convenience method to build proper breadcrumbs for the various views.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">buildBreadcrumbs</span><span class="p">(</span><span class="nx">quiz</span><span class="p">,</span> <span class="nx">question</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span>
    <span class="p">{</span> <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;/admin/quizzes&#39;</span><span class="p">,</span> <span class="nx">label</span><span class="o">:</span> <span class="s1">&#39;Quizzes&#39;</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;/admin/quizzes/&#39;</span> <span class="o">+</span> <span class="nx">quiz</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;/edit&#39;</span><span class="p">,</span> <span class="nx">label</span><span class="o">:</span> <span class="nx">quiz</span><span class="p">.</span><span class="nx">title</span> <span class="p">},</span>
    <span class="p">{</span> <span class="nx">label</span><span class="o">:</span> <span class="nx">question</span> <span class="o">?</span> <span class="nx">question</span><span class="p">.</span><span class="nx">title</span> <span class="o">:</span> <span class="s1">&#39;Nouvelle question&#39;</span> <span class="p">}</span>
  <span class="p">];</span>
<span class="p">}</span></div></div></div></div></body></html>