<!DOCTYPE html><html lang="en"><head><title>app/front/index</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="app/front/index"><meta name="groc-project-path" content="app/front/index.js"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">app/front/index.js</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="front-sub-app-for-quiz-running">Front sub-app for quiz running</h1></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="s1">&#39;use strict&#39;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">fs</span>              <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">passport</span>        <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;passport&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">path</span>            <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">TwitterStrategy</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;passport-twitter&#39;</span><span class="p">).</span><span class="nx">Strategy</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">engine</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../engine&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">_</span>               <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;underscore&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">io</span>              <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">localIP</span>         <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;../client/local_ip&#39;</span><span class="p">).</span><span class="nx">localIP</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">frontOfficeApp</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">OAUTH_CALLBACK_PATH</span> <span class="o">=</span> <span class="s1">&#39;/ohai&#39;</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="subapp-setup">Subapp setup</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is the function this module exports.  Because Express will block
any further middleware once a route is registered, this behaves in two
modes: middleware (non-route) and route (non-middleware).  Calling it
without a mode (or with an invalid mode) does everything.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">frontOfficeApp</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span> <span class="nx">mode</span><span class="p">,</span> <span class="nx">server</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Middleware-only or generic context</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;routes&#39;</span> <span class="o">!==</span> <span class="nx">mode</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">bindWebSockets</span><span class="p">(</span><span class="nx">server</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Subapp-local view path</p></div></div><div class="code"><div class="wrapper">    <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">&#39;/front&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">useLocalViews</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;views&#39;</span><span class="p">));</span>
      <span class="nx">next</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Routes-only or generic context</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;middleware&#39;</span> <span class="o">!==</span> <span class="nx">mode</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Root access should redirect to the frontoffice subapp</p></div></div><div class="code"><div class="wrapper">    <span class="nx">app</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="mi">301</span><span class="p">,</span> <span class="s1">&#39;/front&#39;</span><span class="p">);</span>
    <span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Namespaced quiz running routes</p></div></div><div class="code"><div class="wrapper">    <span class="nx">app</span><span class="p">.</span><span class="nx">namespace</span><span class="p">(</span><span class="s1">&#39;/front&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="nx">mainPage</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Subapp authentication (using a previously registered Twitter strategy,
see the bottom of this file)</p></div></div><div class="code"><div class="wrapper">      <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/auth&#39;</span><span class="p">,</span> <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s1">&#39;twitter&#39;</span><span class="p">));</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>OAuth callback for the Twitter strategy</p></div></div><div class="code"><div class="wrapper">      <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">OAUTH_CALLBACK_PATH</span><span class="p">,</span> <span class="nx">passport</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s1">&#39;twitter&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">successRedirect</span><span class="o">:</span> <span class="s1">&#39;/front&#39;</span><span class="p">,</span>
        <span class="nx">failureFlash</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">failureRedirect</span><span class="o">:</span> <span class="s1">&#39;/front&#39;</span>
      <span class="p">}));</span>
    <span class="p">});</span>
  <span class="p">}</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Action: main page (initial rendering)</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">mainPage</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">engine</span><span class="p">.</span><span class="nx">checkAuth</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">engine</span><span class="p">.</span><span class="nx">currentQuiz</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">engine</span><span class="p">.</span><span class="nx">getUsers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">users</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">user</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="nx">engine</span><span class="o">:</span> <span class="nx">engine</span><span class="p">,</span> <span class="nx">users</span><span class="o">:</span> <span class="nx">users</span> <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">user</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">user</span><span class="p">,</span> <span class="nx">engine</span><span class="o">:</span> <span class="nx">engine</span> <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="websockets-manager">WebSockets manager</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This binds a WebSockets layer over the HTTP app and provides the gateway
between WS traffic and the engine (both ways).</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">bindWebSockets</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">sio</span> <span class="o">=</span> <span class="nx">io</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">server</span><span class="p">);</span>
  <span class="nx">sio</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;log level&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Convenience forwarder when the WS "event" is exactly the same
as the engine-emitted event.</p></div></div><div class="code"><div class="wrapper">  <span class="kd">function</span> <span class="nx">justForward</span><span class="p">(</span><span class="nx">call</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">engine</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">call</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">sio</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">emit</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">sio</span><span class="p">.</span><span class="nx">sockets</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span><span class="p">([</span><span class="nx">call</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">]));</span>
    <span class="p">});</span>
  <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Quiz init: notify waiting clients ("No active quiz yet…" front screens)</p></div></div><div class="code"><div class="wrapper">  <span class="nx">engine</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;quiz-init&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">quiz</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">engine</span><span class="p">.</span><span class="nx">getUsers</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">users</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
      <span class="nx">sio</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;quiz-init&#39;</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pick</span><span class="p">(</span><span class="nx">quiz</span><span class="p">,</span> <span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="s1">&#39;level&#39;</span><span class="p">),</span> <span class="nx">users</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Quiz join: a new user comes in the engine while a quiz is at init stage.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">justForward</span><span class="p">(</span><span class="s1">&#39;quiz-join&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Question start: a new question starts! (including quiz start)</p></div></div><div class="code"><div class="wrapper">  <span class="nx">justForward</span><span class="p">(</span><span class="s1">&#39;question-start&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Answers coming in (input)</p></div></div><div class="code"><div class="wrapper">  <span class="nx">sio</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;answer&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">answer</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="nx">answer</span><span class="p">.</span><span class="nx">userId</span><span class="p">);</span>
      <span class="nx">engine</span><span class="p">.</span><span class="nx">handleAnswer</span><span class="p">(</span><span class="nx">answer</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Answers getting in (output)</p></div></div><div class="code"><div class="wrapper">  <span class="nx">justForward</span><span class="p">(</span><span class="s1">&#39;new-answer&#39;</span><span class="p">);</span>
  <span class="nx">justForward</span><span class="p">(</span><span class="s1">&#39;edit-answer&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Question ends!</p></div></div><div class="code"><div class="wrapper">  <span class="nx">justForward</span><span class="p">(</span><span class="s1">&#39;question-end&#39;</span><span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Quiz ends!</p></div></div><div class="code"><div class="wrapper">  <span class="nx">engine</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;quiz-end&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">scoreboard</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>For every socket, check whether it's a player, and if so get and send their scoring.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">sio</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">clients</span><span class="p">().</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;userId&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">userId</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">scoring</span> <span class="o">=</span> <span class="nx">userId</span> <span class="o">&amp;&amp;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">findWhere</span><span class="p">(</span><span class="nx">scoreboard</span><span class="p">,</span> <span class="p">{</span><span class="err"> </span><span class="nx">id</span><span class="o">:</span> <span class="nx">userId</span> <span class="p">});</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">scoring</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">scoring</span><span class="p">.</span><span class="nx">rank</span> <span class="o">=</span> <span class="nx">scoreboard</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">scoring</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;quiz-end&#39;</span><span class="p">,</span> <span class="nx">scoring</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="frontoffice-authentication-setup">Frontoffice authentication setup</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Read credentials off a JSON file
in this file's directory and initialize a Passport Twitter OAuth strategy
with those.</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">readCredentials</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">&#39;credentials.json&#39;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">&quot;Missing frontoffice credentials -&gt; You won&#39;t be able to authenticate!&quot;</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">creds</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">json</span> <span class="o">||</span> <span class="s1">&#39;{}&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">creds</span><span class="p">.</span><span class="nx">consumerKey</span> <span class="o">&amp;&amp;</span> <span class="nx">creds</span><span class="p">.</span><span class="nx">consumerSecret</span><span class="p">)</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Front credentials loaded&quot;</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;One or more blank front credential -&gt; You won&#39;t be able to authenticate!&quot;</span><span class="p">);</span>

    <span class="nx">cb</span><span class="p">(</span><span class="nx">creds</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Read the OAuth credentials (consumer key, consumer secret) for the Twitter App
you registered as a developer, then define a Twitter strategy
the Passport authentication middleware can use (see above)</p></div></div><div class="code"><div class="wrapper"><span class="nx">readCredentials</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">creds</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;OAuth callback IP&#39;</span><span class="p">,</span> <span class="nx">localIP</span><span class="p">);</span>

  <span class="nx">passport</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="k">new</span> <span class="nx">TwitterStrategy</span><span class="p">(</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">creds</span><span class="p">,</span> <span class="p">{</span> <span class="nx">callbackURL</span><span class="o">:</span> <span class="s1">&#39;http://&#39;</span> <span class="o">+</span> <span class="nx">localIP</span> <span class="o">+</span> <span class="s1">&#39;:3000/front&#39;</span> <span class="o">+</span> <span class="nx">OAUTH_CALLBACK_PATH</span> <span class="p">}),</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p><em>.extend(creds, { callbackURL: 'http://node-francejs.' + localIP + '.xip.io/front' + OAUTH</em>CALLBACK_PATH }),</p></div></div><div class="code"><div class="wrapper">    <span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">tokenSecret</span><span class="p">,</span> <span class="nx">profile</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">user</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">id</span><span class="o">:</span> <span class="nx">profile</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
        <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;@&#39;</span> <span class="o">+</span> <span class="nx">profile</span><span class="p">.</span><span class="nx">displayName</span><span class="p">,</span>
        <span class="nx">avatar</span><span class="o">:</span> <span class="p">(</span><span class="nx">profile</span><span class="p">.</span><span class="nx">photos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="p">{}).</span><span class="nx">value</span>
      <span class="p">};</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;TWITTER USER: &#39;</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
      <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">));</span>

  <span class="nx">passport</span><span class="p">.</span><span class="nx">serializeUser</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">passport</span><span class="p">.</span><span class="nx">deserializeUser</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">done</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span></div></div></div></div></body></html>